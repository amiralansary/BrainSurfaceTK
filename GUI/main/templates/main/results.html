{% extends 'main/header.html' %}
{% load static %}

{% block title %}Results{% endblock %}

{% block content %}
    <style>
        #brain_surf_container {
            position: relative !important;
            width: 100% !important;
            height: 50% !important;
        }

        .GeometryViewer-module-selector_2T5dG {
            display: initial;
        }
    </style>

    <h1>Session-{{ session_id }}</h1>
    <div id="brain-container">
        {% if mri_js_html is not None %}
            <div class="brain_slice_container">
                {{ mri_js_html | safe }}
            </div>
        {% endif %}

        {% if surf_file_path is not None %}
            <div id="brain_surf_container">
                <div class="GeometryViewer-module-fullScreen_38Xg_"></div>
            </div>
            <script id="brain_surf" data-fileURL="{% get_media_prefix %}{{ surf_file_path }}"
                    type="text/javascript" src="{% static "main/js/MyWebApp.js" | safe %}"></script>
        {% endif %}
    </div>
    <table id="info_table">
        <thead>
        {% for table_name in table_names %}
            <th>
                {{ table_name }}
            </th>
        {% endfor %}
        </thead>
        <tbody>
        {% for value in table_values %}
            <td>{{ value }}</td>
        {% endfor %}
        </tbody>
    </table>

    {% csrf_token %}
    <div id="prediction_container">
        <button class="waves-effect waves-light btn-small" id="predict" type="submit" formmethod="get">Predict</button>
        {% if pred is not None %}
            Prediction be printed here
        {% endif %}
    </div>

    <script>
    $('#predict').click(function() {
        document.getElementById("predict").style.color = "red";
        console.log("create post is working!");
        var table_Exists = document.getElementById("result_table");

        if (table_Exists == null){

            var objCells = document.getElementById("info_table").rows.item(1).cells;
            console.log(objCells.item(0).innerHTML);

            $.ajax({
                url : "run_predictions/",
                type : "POST",
                data: {
                    'participant_id': objCells.item(0).innerHTML,
                    'session_id': objCells.item(1).innerHTML,
                    'file_path': "{% get_media_prefix %}{{ surf_file_path }}"
                },

                success : function(json) {
                    $('#post-text').val('');
                    console.log(json);
                    console.log("success");
                    console.log(json.pred);

                    display_results(json.pred);
                }
            });
        }
    });

    function display_results(pred) {

        var table_Exists = document.getElementById("result_table");

        if (table_Exists == null)
        {
            // CREATE DYNAMIC TABLE.
            var table = document.createElement('table');

            // SET THE TABLE ID.
            // WE WOULD NEED THE ID TO TRAVERSE AND EXTRACT DATA FROM THE TABLE.
            table.setAttribute('id', 'result_table');

            var arrHead = new Array();
            arrHead = ['Predicted age'];

            var arrValue = new Array();
            arrValue.push([pred]);

            var tr = table.insertRow(-1);

            for (var h = 0; h < arrHead.length; h++) {
                var th = document.createElement('th');              // TABLE HEADER.
                th.innerHTML = arrHead[h];
                tr.appendChild(th);
            }

            for (var c = 0; c <= arrValue.length - 1; c++) {
                tr = table.insertRow(-1);

                for (var j = 0; j < arrHead.length; j++) {
                    var td = document.createElement('td');          // TABLE DEFINITION.
                    td = tr.insertCell(-1);
                    td.innerHTML = arrValue[c][j];                  // ADD VALUES TO EACH CELL.
                }
            }

            // FINALLY ADD THE NEWLY CREATED TABLE AND BUTTON TO THE BODY.
            document.getElementById("prediction_container").appendChild(table);
        }
    }

    </script>

{% endblock %}